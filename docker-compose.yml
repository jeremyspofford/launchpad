version: '3.8'

services:
  # Test minimal installation
  test-minimal:
    build:
      context: .
      target: test-minimal
    container_name: dotfiles-test-minimal
    volumes:
      - .:/home/testuser/dotfiles:ro
    command: ["./verify.sh", "--quick"]

  # Test full installation  
  test-full:
    build:
      context: .
      target: test-full
    container_name: dotfiles-test-full
    volumes:
      - .:/home/testuser/dotfiles:ro
    command: ["./verify.sh"]

  # Development environment for interactive testing
  development:
    build:
      context: .
      target: development
    container_name: dotfiles-dev
    volumes:
      - .:/home/testuser/dotfiles
      - dev-home:/home/testuser
    working_dir: /home/testuser/dotfiles
    stdin_open: true
    tty: true
    environment:
      - TERM=xterm-256color
    command: ["/bin/bash"]

  # Production-like environment
  production:
    build:
      context: .
      target: production
    container_name: dotfiles-prod
    volumes:
      - prod-home:/home/user
    stdin_open: true
    tty: true
    environment:
      - TERM=xterm-256color
    command: ["/bin/zsh"]

  # Test on different Ubuntu versions
  ubuntu-20:
    build:
      context: .
      dockerfile: Dockerfile.ubuntu
      args:
        UBUNTU_VERSION: "20.04"
    container_name: dotfiles-ubuntu-20
    volumes:
      - .:/dotfiles:ro

  ubuntu-22:
    build:
      context: .
      dockerfile: Dockerfile.ubuntu
      args:
        UBUNTU_VERSION: "22.04"
    container_name: dotfiles-ubuntu-22
    volumes:
      - .:/dotfiles:ro

  ubuntu-24:
    build:
      context: .
      dockerfile: Dockerfile.ubuntu
      args:
        UBUNTU_VERSION: "24.04"
    container_name: dotfiles-ubuntu-24
    volumes:
      - .:/dotfiles:ro

volumes:
  dev-home:
    driver: local
  prod-home:
    driver: local

networks:
  default:
    name: dotfiles-network