[tools]
python = "3.12.11"
"python:pip:git-filter-repo" = "latest"

[tasks.scrub-secret]
description = "Remove a secret from git history"
run = """
#!/usr/bin/env bash
set -euo pipefail

if [[ -z "${1:-}" ]]; then
    echo "Usage: mise run scrub-secret <secret-text> [replacement]"
    echo "Example: mise run scrub-secret 'my-api-key-123' '***REDACTED***'"
    exit 1
fi

SECRET="${1}"
REPLACEMENT="${2:-***REDACTED***}"

# Save the current remote URL before filter-repo removes it
ORIGIN_URL=$(git remote get-url origin 2>/dev/null || echo "")

echo "Creating replacements file..."
echo "${SECRET}==>${REPLACEMENT}" > /tmp/replacements.txt

echo "Running git-filter-repo..."
git-filter-repo --replace-text /tmp/replacements.txt --force

# Re-add origin if it existed
if [[ -n "$ORIGIN_URL" ]]; then
    echo "Re-adding origin: $ORIGIN_URL"
    git remote add origin "$ORIGIN_URL" 2>/dev/null || true
fi

echo "Done! Now run: git push origin main --force"
"""
