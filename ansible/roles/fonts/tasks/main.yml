---
- name: Install Nerd Fonts on macOS
  community.general.homebrew_cask:
    name: "{{ macos_font_casks }}"
    state: present
  when: ansible_os_family == 'Darwin'

- name: Install Nerd Fonts on Linux
  when: ansible_os_family != 'Darwin'
  block:
    - name: Set font directory for Linux
      set_fact:
        font_dir: "{{ ansible_env.HOME }}/.local/share/fonts"

    - name: Check if font is already installed
      stat:
        path: "{{ font_dir }}/JetBrainsMonoNerdFont-Regular.ttf"
      register: font_file_check

    - name: Install font tasks for Linux
      when: not font_file_check.stat.exists
      block:
        - name: Ensure font directory exists
          file:
            path: "{{ font_dir }}"
            state: directory
            mode: '0755'

        - name: Download and unarchive font
          unarchive:
            src: https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.tar.xz
            dest: /tmp/jetbrainsmono_font
            remote_src: yes
            creates: /tmp/jetbrainsmono_font/JetBrainsMonoNerdFont-Regular.ttf

        - name: Copy font files
          copy:
            src: "/tmp/jetbrainsmono_font/"
            dest: "{{ font_dir }}"
            remote_src: yes

        - name: Update font cache on Linux
          command: fc-cache -fv
          changed_when: false

        - name: Clean up temporary font directory
          file:
            path: /tmp/jetbrainsmono_font
            state: absent
