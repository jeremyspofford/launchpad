#SPDX-License-Identifier: MIT-0
---
# tasks file for aws_install

- name: Install AWS CLI
  community.general.homebrew:
    name: awscli
    state: present
  when: ansible_os_family == "Darwin"
  become: false

- name: Install AWS Q
  community.general.homebrew_cask:
    name: amazon-q
    state: present
  when: ansible_os_family == "Darwin"
  become: false
  register: amazon_q_install_result

- name: Create .local/bin directory if it doesn't exist
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.local/bin"
    state: directory
    mode: '0755'
  when: ansible_os_family == "Darwin"
  become: false

- name: Check if Amazon Q app exists
  ansible.builtin.stat:
    path: "/Applications/Amazon Q.app/Contents/MacOS/q"
  when: ansible_os_family == "Darwin"
  register: amazon_q_binary_check

- name: Create symlink for q command in user bin directory
  ansible.builtin.file:
    src: "/Applications/Amazon Q.app/Contents/MacOS/q"
    dest: "{{ ansible_env.HOME }}/.local/bin/q"
    state: link
    mode: '0755'
  when: 
    - ansible_os_family == "Darwin"
    - amazon_q_binary_check.stat.exists
  become: false
  ignore_errors: true

# - name: Install AWS Q
#   community.general.homebrew:
#     name: amazon-q
#     state: present
#   when: ansible_os_family == "Darwin"
#   become: false
