---
- name: Check if rbenv is installed via Homebrew
  ansible.builtin.stat:
    path: /opt/homebrew/bin/rbenv
  register: rbenv_check_arm

- name: Check if rbenv is installed via Homebrew (Intel)
  ansible.builtin.stat:
    path: /usr/local/bin/rbenv
  register: rbenv_check_intel

- name: Set rbenv path
  ansible.builtin.set_fact:
    rbenv_path: "{{ '/opt/homebrew/bin/rbenv' if rbenv_check_arm.stat.exists else '/usr/local/bin/rbenv' if rbenv_check_intel.stat.exists else '' }}"

- name: Configure rbenv in shell profile
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    line: 'eval "$(rbenv init - zsh)"'
    create: true
    backup: true
    insertafter: '^# Load rbenv'
  when: rbenv_path != ""

- name: Add rbenv init comment
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    line: '# Load rbenv'
    create: true
    backup: true
    insertbefore: '^eval "\$\\(rbenv init - zsh\\)"'
  when: rbenv_path != ""

- name: Initialize rbenv if installed
  ansible.builtin.shell: |
    export PATH="{{ rbenv_path | dirname }}:$PATH"
    eval "$(rbenv init -)"
    rbenv --version
  register: rbenv_init
  changed_when: false
  when: rbenv_path != ""

- name: Check if Ruby version is already installed via rbenv
  ansible.builtin.shell: |
    export PATH="{{ rbenv_path | dirname }}:$PATH"
    eval "$(rbenv init -)"
    rbenv versions | grep -q "{{ ruby_version }}"
  register: ruby_version_check
  changed_when: false
  failed_when: false
  when: rbenv_path != ""

- name: Install Ruby version via rbenv
  ansible.builtin.shell: |
    export PATH="{{ rbenv_path | dirname }}:$PATH"
    eval "$(rbenv init -)"
    rbenv install {{ ruby_version }}
  when: 
    - rbenv_path != ""
    - ruby_version_check.rc != 0

- name: Set global Ruby version
  ansible.builtin.shell: |
    export PATH="{{ rbenv_path | dirname }}:$PATH"
    eval "$(rbenv init -)"
    rbenv global {{ ruby_version }}
  when: rbenv_path != ""

- name: Update RubyGems
  ansible.builtin.shell: |
    export PATH="{{ rbenv_path | dirname }}:$PATH"
    eval "$(rbenv init -)"
    gem update --system
  when: rbenv_path != ""

- name: Install Bundler
  ansible.builtin.shell: |
    export PATH="{{ rbenv_path | dirname }}:$PATH"
    eval "$(rbenv init -)"
    gem install bundler
  when: rbenv_path != ""

- name: Install Jekyll gem
  ansible.builtin.shell: |
    export PATH="{{ rbenv_path | dirname }}:$PATH"
    eval "$(rbenv init -)"
    gem install jekyll
  when: rbenv_path != ""
