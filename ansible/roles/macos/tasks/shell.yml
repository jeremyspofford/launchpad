---
# ============================================================================ #
# Shell Configuration for macOS
# ============================================================================ #
# Ensures modern Bash is installed and properly configured
# macOS ships with Bash 3.2.57 (2007) - we need 4+ for modern features
# ============================================================================ #

- name: Check current Bash version
  ansible.builtin.shell: /bin/bash --version | head -n1
  register: system_bash_version
  changed_when: false

- name: Display current system Bash version
  ansible.builtin.debug:
    msg: "Current system Bash: {{ system_bash_version.stdout }}"

- name: Check if modern Bash is installed via Homebrew
  ansible.builtin.stat:
    path: /opt/homebrew/bin/bash
  register: homebrew_bash

- name: Check if modern Bash is in /usr/local/bin (Intel Mac)
  ansible.builtin.stat:
    path: /usr/local/bin/bash
  register: local_bash

- name: Get modern Bash version if available
  ansible.builtin.shell: |
    if [ -f /opt/homebrew/bin/bash ]; then
      /opt/homebrew/bin/bash --version | head -n1
    elif [ -f /usr/local/bin/bash ]; then
      /usr/local/bin/bash --version | head -n1
    else
      echo "Modern Bash not found"
    fi
  register: modern_bash_version
  changed_when: false

- name: Display modern Bash version
  ansible.builtin.debug:
    msg: "Modern Bash: {{ modern_bash_version.stdout }}"

- name: Check if Homebrew Bash is already in /etc/shells (Apple Silicon)
  ansible.builtin.lineinfile:
    path: /etc/shells
    line: /opt/homebrew/bin/bash
    state: present
    create: false
  become: true
  when: homebrew_bash.stat.exists
  check_mode: yes
  register: shells_check_homebrew

- name: Add Homebrew Bash to /etc/shells (Apple Silicon)
  ansible.builtin.lineinfile:
    path: /etc/shells
    line: /opt/homebrew/bin/bash
    create: false
  become: true
  when: 
    - homebrew_bash.stat.exists
    - shells_check_homebrew is changed

- name: Check if Homebrew Bash is already in /etc/shells (Intel)
  ansible.builtin.lineinfile:
    path: /etc/shells
    line: /usr/local/bin/bash
    state: present
    create: false
  become: true
  when: local_bash.stat.exists and not homebrew_bash.stat.exists
  check_mode: yes
  register: shells_check_intel

- name: Add Homebrew Bash to /etc/shells (Intel)
  ansible.builtin.lineinfile:
    path: /etc/shells
    line: /usr/local/bin/bash
    create: false
  become: true
  when: 
    - local_bash.stat.exists 
    - not homebrew_bash.stat.exists
    - shells_check_intel is changed

- name: Check current user shell
  ansible.builtin.shell: echo $SHELL
  register: current_shell
  changed_when: false

- name: Display current shell
  ansible.builtin.debug:
    msg: "Current shell: {{ current_shell.stdout }}"

- name: Inform about shell change option
  ansible.builtin.debug:
    msg: |
      Modern Bash is now installed and available.
      
      To use modern Bash as your default shell, run:
      {% if homebrew_bash.stat.exists %}
      chsh -s /opt/homebrew/bin/bash
      {% elif local_bash.stat.exists %}
      chsh -s /usr/local/bin/bash
      {% endif %}
      
      Or add to your .bashrc/.zshrc:
      {% if homebrew_bash.stat.exists %}
      alias bash='/opt/homebrew/bin/bash'
      {% elif local_bash.stat.exists %}
      alias bash='/usr/local/bin/bash'
      {% endif %}
  when: homebrew_bash.stat.exists or local_bash.stat.exists

# Note: Modern Bash alias is already configured in .commonrc