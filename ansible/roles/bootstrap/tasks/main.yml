---
# Essential package installation for dotfiles

- name: Install Debian/Ubuntu packages
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    # Core utilities
    - build-essential
    - curl
    - wget
    - git
    - unzip
    - software-properties-common
    
    # Shell and terminal
    - zsh
    - tmux
    - neovim
    
    # Modern CLI tools
    - fzf
    - ripgrep
    - fd-find
    - bat
    - jq
    - tree
    
    # Development
    - nodejs
    - npm
    
    # System utilities
    - htop
    - ncdu
    - fontconfig
    
    # Code quality tools
    - shellcheck
    - yamllint
    
    # Package managers and utils  
    - python3-pip
    - yq
  become: yes
  when: ansible_os_family == "Debian"

- name: Install macOS packages via Homebrew
  homebrew:
    name: "{{ item }}"
    state: present
  loop:
    # Core utilities
    - curl
    - wget
    - git
    
    # Shell and terminal
    - zsh
    - tmux
    - neovim
    
    # Modern CLI tools
    - fzf
    - ripgrep
    - fd
    - bat
    - eza
    - jq
    - tree
    
    # Development
    - node
    - npm
    - gh  # GitHub CLI
    
    # System utilities
    - htop
    - ncdu
    
    # Code quality tools
    - shellcheck
    - yamllint
    
    # System utilities continued  
    - python3-pip
    - delta
    
    # ZSH plugins
    - zsh-autosuggestions
    - zsh-syntax-highlighting
    - zsh-history-substring-search
    
    # Version manager
    - mise
    
    # Prompt
    - starship
    
    # Dotfile management
    - chezmoi
  when: ansible_os_family == "Darwin"

# Install tools not in standard repos
- name: Install eza on Linux (modern ls replacement)
  shell: |
    if ! command -v eza >/dev/null 2>&1; then
      ARCH=$(uname -m)
      if [ "$ARCH" = "x86_64" ]; then
        curl -sL https://github.com/eza-community/eza/releases/latest/download/eza_x86_64-unknown-linux-gnu.tar.gz | sudo tar xz -C /usr/local/bin
      elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
        curl -sL https://github.com/eza-community/eza/releases/latest/download/eza_aarch64-unknown-linux-gnu.tar.gz | sudo tar xz -C /usr/local/bin
      fi
    fi
  when: ansible_os_family == "Debian"
  ignore_errors: yes

- name: Install delta on Linux (git diff tool)
  shell: |
    if ! command -v delta >/dev/null 2>&1; then
      ARCH=$(uname -m)
      VERSION=$(curl -s https://api.github.com/repos/dandavison/delta/releases/latest | grep tag_name | cut -d'"' -f4)
      if [ "$ARCH" = "x86_64" ]; then
        curl -sL "https://github.com/dandavison/delta/releases/download/${VERSION}/delta-${VERSION}-x86_64-unknown-linux-gnu.tar.gz" | sudo tar xz -C /usr/local/bin --strip-components=1 delta-${VERSION}-x86_64-unknown-linux-gnu/delta
      fi
    fi
  when: ansible_os_family == "Debian"
  ignore_errors: yes

- name: Install chezmoi on Linux
  shell: |
    if ! command -v chezmoi >/dev/null 2>&1; then
      sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
    fi
  when: ansible_os_family == "Debian"
  become: no

- name: Install starship on Linux
  shell: |
    if ! command -v starship >/dev/null 2>&1; then
      curl -sS https://starship.rs/install.sh | sh -s -- --yes
    fi
  when: ansible_os_family == "Debian"
  become: no

- name: Install mise on Linux
  shell: |
    if ! command -v mise >/dev/null 2>&1; then
      curl https://mise.run | sh
    fi
  when: ansible_os_family == "Debian"
  become: no

- name: Install GitHub CLI on Linux
  shell: |
    if ! command -v gh >/dev/null 2>&1; then
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
      sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
      sudo apt update
      sudo apt install gh -y
    fi
  when: ansible_os_family == "Debian"

- name: Create fd symlink on Debian/Ubuntu
  file:
    src: /usr/bin/fdfind
    dest: /usr/local/bin/fd
    state: link
  become: yes
  when: ansible_os_family == "Debian"
  ignore_errors: yes

- name: Create batcat symlink on Debian/Ubuntu
  file:
    src: /usr/bin/batcat
    dest: /usr/local/bin/bat
    state: link
  become: yes
  when: ansible_os_family == "Debian"
  ignore_errors: yes

- name: Install Claude CLI globally
  npm:
    name: "@anthropic-ai/claude-cli"
    global: yes
  become: yes

- name: Install useful npm packages globally
  npm:
    name: "{{ item }}"
    global: yes
  loop:
    - tldr
    - npm-check-updates
  become: yes
  when: ansible_os_family == "Debian"

- name: Install zoxide on Linux
  shell: |
    if ! command -v zoxide >/dev/null 2>&1; then
      curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
    fi
  when: ansible_os_family == "Debian"
  become: no

- name: Install ZSH plugins on Linux
  git:
    repo: "{{ item.repo }}"
    dest: "{{ item.dest }}"
  loop:
    - { repo: 'https://github.com/zsh-users/zsh-autosuggestions', dest: '/usr/share/zsh-autosuggestions' }
    - { repo: 'https://github.com/zsh-users/zsh-syntax-highlighting', dest: '/usr/share/zsh-syntax-highlighting' }
    - { repo: 'https://github.com/zsh-users/zsh-history-substring-search', dest: '/usr/share/zsh-history-substring-search' }
  become: yes
  when: ansible_os_family == "Debian"
  ignore_errors: yes