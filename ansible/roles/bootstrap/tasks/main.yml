- name: Install Debian packages (Debian/Ubuntu)
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    - build-essential
    - curl
    - fzf
    - git
    - gnupg
    - jq
    - locate
    - ripgrep
    - tmux
    - unzip
    - util-linux
    - xclip
    - zoxide
    - zsh
    - bat
    - fd-find
  become: yes
  when: ansible_os_family == "Debian"

- name: Install macOS packages via Homebrew
  homebrew:
    name: "{{ item }}"
    state: present
  loop:
    - curl
    - fzf
    - git
    - gnu-getopt
    - jq
    - ripgrep
    - tmux
    - zoxide
    - zsh
    - exa
    - bat
    - fd
  when: ansible_os_family == "Darwin"

- name: Install chezmoi (Linux)
  shell: |
    if ! command -v chezmoi >/dev/null 2>&1; then
      sh -c "$(curl -fsLS get.chezmoi.io)"
    fi
  when: ansible_os_family == "Debian"

- name: Install chezmoi (macOS)
  homebrew:
    name: chezmoi
    state: present
  when: ansible_os_family == "Darwin"

- name: Install mise (cross-platform)
  shell: |
    if ! command -v mise >/dev/null 2>&1; then
      curl https://mise.run | sh
    fi

- name: Add mise to PATH for current session
  shell: |
    if [ -f ~/.local/bin/mise ]; then
      ~/.local/bin/mise install -y || true
    elif command -v mise >/dev/null 2>&1; then
      mise install -y || true
    fi

- name: Install Starship (cross-platform)
  shell: |
    if ! command -v starship >/dev/null 2>&1; then
      curl -sS https://starship.rs/install.sh | sh -s -- --yes
    fi

- name: Install exa via GitHub release (Linux)
  shell: |
    if ! command -v exa >/dev/null 2>&1; then
      # Download and install exa from GitHub releases
      ARCH=$(uname -m)
      if [ "$ARCH" = "x86_64" ]; then
        curl -L https://github.com/ogham/exa/releases/download/v0.10.1/exa-linux-x86_64-v0.10.1.zip -o /tmp/exa.zip
        unzip -o /tmp/exa.zip -d /tmp/
        sudo mv /tmp/bin/exa /usr/local/bin/
        sudo chmod +x /usr/local/bin/exa
        rm -f /tmp/exa.zip
        rm -rf /tmp/bin
      fi
    fi
  when: ansible_os_family == "Debian"
  ignore_errors: yes

- name: Create fd symlink for Ubuntu (fd-find package installs as fdfind)
  file:
    src: /usr/bin/fdfind
    dest: /usr/local/bin/fd
    state: link
  become: yes
  when: ansible_os_family == "Debian"
  ignore_errors: yes
