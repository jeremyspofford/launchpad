# Common environment variables for Bash and Zsh

# XDG Base Directory Specification
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_CACHE_HOME="$HOME/.cache"
export XDG_STATE_HOME="$HOME/.local/state"

# Editor configuration
if [[ -n $SSH_CONNECTION ]]; then
  export EDITOR='vim'
else
  export EDITOR='nvim'
fi
export VISUAL="$EDITOR"

# Browser configuration
if [[ "$OSTYPE" == "darwin"* ]]; then
    export BROWSER="open"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    export BROWSER="xdg-open"
fi

# Development directories
export DEV_DIR="$HOME/Development"
export PROJECT_DIR="$DEV_DIR"
export WORKSPACE_DIR="$DEV_DIR"

# Tool-specific configuration directories
export MISE_CONFIG_DIR="$XDG_CONFIG_HOME/mise"
export STARSHIP_CONFIG="$XDG_CONFIG_HOME/starship/starship.toml"

# Language-specific environment variables
export PYTHONPATH="$HOME/.local/lib/python3/site-packages:$PYTHONPATH"
export PIP_USER=1
export PIPENV_VENV_IN_PROJECT=1
export POETRY_VENV_IN_PROJECT=true

# Node.js and npm
export NPM_CONFIG_PREFIX="$HOME/.local"
export NODE_REPL_HISTORY="$XDG_DATA_HOME/node_repl_history"

# Docker
export DOCKER_CONFIG="$XDG_CONFIG_HOME/docker"
export COMPOSE_FILE="docker-compose.yml"

# SSH
export SSH_KEY_PATH="${SSH_KEY_PATH:-$HOME/.ssh/id_ed25519_personal}"

# History configuration (shell-agnostic location)
export HISTSIZE=50000
export SAVEHIST=50000
# Note: HISTFILE set per-shell in .zshrc/.bashrc

# Less settings
export LESS="-R"
export LESSHISTFILE="$XDG_DATA_HOME/less/history"

# Man pages with bat
export MANPAGER="sh -c 'col -bx | bat -l man -p'"

# FZF settings
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border --multi --cycle'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_CTRL_T_OPTS='--preview "bat --color=always --style=numbers --line-range=:500 {}"'
export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
export FZF_ALT_C_OPTS='--preview "tree -C {} | head -200"'

# Bat (better cat) settings
export BAT_THEME="GitHub"
export BAT_CONFIG_PATH="$XDG_CONFIG_HOME/bat/config"

# Zoxide settings
export _ZO_DATA_DIR="$XDG_DATA_HOME/zoxide"

# Performance and behavior
export DISABLE_AUTO_TITLE="true"
export ENABLE_CORRECTION="false"
export COMPLETION_WAITING_DOTS="true"

# Security
# GPG_TTY moved to .commonrc.lazy for faster startup
# export GPG_TTY=$(tty)

# SSH Key Management
# Moved to .commonrc.lazy for faster startup - SSH agent operations are expensive
# The SSH_KEY_PATH variable is still set here for reference

# Locale settings
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"
export LC_CTYPE="en_US.UTF-8"

# Pager settings
export PAGER="less"
# Bat check moved to lazy loading for micro-optimization
# export PAGER="bat"  # Uncomment if you always want bat

# Platform-specific environment variables and aliases
case "$OSTYPE" in
    darwin*)
        # macOS specific
        export HOMEBREW_NO_ANALYTICS=1
        export HOMEBREW_NO_AUTO_UPDATE=1
        alias start="open"
        
        # Modern Bash alias (macOS ships with ancient 3.2.57 from 2007)
        if [[ -x "/opt/homebrew/bin/bash" ]]; then
            alias bash="/opt/homebrew/bin/bash"
        elif [[ -x "/usr/local/bin/bash" ]]; then
            alias bash="/usr/local/bin/bash"
        fi
        ;;
    linux-gnu*)
        # Linux specific
        export DISPLAY=":0"
        # Check if we're in WSL
        if grep -qi microsoft /proc/version 2>/dev/null || [[ "$WSL_DISTRO_NAME" != "" ]]; then
            # WSL specific
            alias start="explorer.exe"
            export WSLENV="USERPROFILE/p:APPDATA/p"
        else
            # Native Linux
            alias start="xdg-open"
        fi
        ;;
    msys|cygwin)
        # Windows specific
        export WSLENV="USERPROFILE/p:APPDATA/p"
        alias start="explorer.exe"
        ;;
esac

# NVM (Node Version Manager) - common part
export NVM_DIR="$HOME/.nvm"

# Common PATH additions
export PATH="$HOME/.local/bin:$HOME/bin:$PATH"
export PATH="$HOME/.cursor/bin:$PATH" 
export PATH="$PATH:/opt/nvim-linux-x86_64/bin"

# Dotfiles sync function (forwards all arguments)
# Dynamically finds the dotfiles directory based on the sync.sh script location
# Note: Named dotfiles-sync to avoid conflict with 'sync' alias in .aliases
dotfiles-sync() {
    # Try to find sync.sh in common locations
    local sync_script=""

    # Check if DOTFILES_DIR is set
    if [[ -n "$DOTFILES_DIR" ]] && [[ -x "$DOTFILES_DIR/scripts/sync.sh" ]]; then
        sync_script="$DOTFILES_DIR/scripts/sync.sh"
    # Check common location
    elif [[ -x "$HOME/workspace/dotfiles/scripts/sync.sh" ]]; then
        sync_script="$HOME/workspace/dotfiles/scripts/sync.sh"
    # Check if we're in a dotfiles repo
    elif [[ -x "./scripts/sync.sh" ]]; then
        sync_script="./scripts/sync.sh"
    # Check parent directory
    elif [[ -x "../scripts/sync.sh" ]]; then
        sync_script="../scripts/sync.sh"
    else
        echo "Error: sync.sh not found. Please set DOTFILES_DIR or ensure dotfiles are in ~/workspace/dotfiles" >&2
        return 1
    fi

    "$sync_script" "$@"
}

# 1Password Secrets Management
# Source secrets file if it exists (created by scripts/sync-secrets.sh)
# Always auto-load local secrets file (no 1Password authentication required)
if [[ -f "$HOME/.secrets" ]]; then
    source "$HOME/.secrets"
    # Only show message if secrets weren't already loaded
    if [[ -z "${SECRETS_LOADED:-}" ]]; then
        echo "âœ… Secrets loaded from ~/.secrets (run 'sync-secrets' to refresh from 1Password)"
        echo "run 'verify_secrets' to list loaded secrets"
    fi
else
    echo "ðŸ’¡ No secrets file found. Run 'sync-secrets' to create one from 1Password"
fi

# Function to load existing secrets (no 1Password authentication)
load-secrets() {
    if [[ -f "$HOME/.secrets" ]]; then
        source "$HOME/.secrets"
        echo "âœ… Secrets loaded from ~/.secrets"
    else
        echo "âŒ No secrets file found. Run 'sync-secrets' to create one from 1Password"
        return 1
    fi
}

# Function to sync secrets from 1Password (requires authentication)
sync-secrets() {
    local dotfiles_dir="${DOTFILES_DIR:-$HOME/workspace/dotfiles}"
    local sync_script="$dotfiles_dir/scripts/sync-secrets.sh"
    
    if [[ -x "$sync_script" ]]; then
        echo "ðŸ” Authenticating with 1Password..."
        "$sync_script" "$@"
        # Reload secrets after syncing
        if [[ -f "$HOME/.secrets" ]]; then
            source "$HOME/.secrets"
            echo "âœ… Secrets synced and loaded in current shell"
        fi
    else
        echo "Error: sync-secrets.sh not found at $sync_script" >&2
        return 1
    fi
}

# AWS SSO
# function sso() {
#   PS3="Please select your AWS profile: "
#   COLUMNS=12
#   profiles=`awk 'match($0, /\[profile (.+)\]/, captured) { print captured[1] }' ~/.aws/config | sort`
#   select profile in $profiles
#   do
#     echo $profile
#     ~/.aws_sso.py $profile
#     break;
#   done
# }
