# Common environment variables for Bash and Zsh

# XDG Base Directory Specification
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_CACHE_HOME="$HOME/.cache"
export XDG_STATE_HOME="$HOME/.local/state"

# Editor configuration
if [[ -n $SSH_CONNECTION ]]; then
  export EDITOR='vim'
else
  export EDITOR='nvim'
fi
export VISUAL="$EDITOR"

# Browser configuration
if [[ "$OSTYPE" == "darwin"* ]]; then
    export BROWSER="open"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    export BROWSER="xdg-open"
fi

# Development directories
export DEV_DIR="$HOME/Development"
export PROJECT_DIR="$DEV_DIR"
export WORKSPACE_DIR="$DEV_DIR"

# Tool-specific configuration directories
export MISE_CONFIG_DIR="$XDG_CONFIG_HOME/mise"
export STARSHIP_CONFIG="$XDG_CONFIG_HOME/starship/starship.toml"

# Language-specific environment variables
export PYTHONPATH="$HOME/.local/lib/python3/site-packages:$PYTHONPATH"
export PIP_USER=1
export PIPENV_VENV_IN_PROJECT=1
export POETRY_VENV_IN_PROJECT=true

# Node.js and npm
export NPM_CONFIG_PREFIX="$HOME/.local"
export NODE_REPL_HISTORY="$XDG_DATA_HOME/node_repl_history"

# Docker
export DOCKER_CONFIG="$XDG_CONFIG_HOME/docker"
export COMPOSE_FILE="docker-compose.yml"

# SSH
export SSH_KEY_PATH="$HOME/.ssh/id_ed25519_personal"

# History configuration (shell-agnostic location)
export HISTSIZE=50000
export SAVEHIST=50000
# Note: HISTFILE set per-shell in .zshrc/.bashrc

# Less settings
export LESS="-R"
export LESSHISTFILE="$XDG_DATA_HOME/less/history"

# Man pages with bat
export MANPAGER="sh -c 'col -bx | bat -l man -p'"

# FZF settings
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border --multi --cycle'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_CTRL_T_OPTS='--preview "bat --color=always --style=numbers --line-range=:500 {}"'
export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
export FZF_ALT_C_OPTS='--preview "tree -C {} | head -200"'

# Bat (better cat) settings
export BAT_THEME="GitHub"
export BAT_CONFIG_PATH="$XDG_CONFIG_HOME/bat/config"

# Zoxide settings
export _ZO_DATA_DIR="$XDG_DATA_HOME/zoxide"

# Performance and behavior
export DISABLE_AUTO_TITLE="true"
export ENABLE_CORRECTION="false"
export COMPLETION_WAITING_DOTS="true"

# Security
export GPG_TTY=$(tty)

# SSH Key Management
# Ensure SSH agent is running and keys are loaded
if command -v ssh-add >/dev/null 2>&1; then
    # Start ssh-agent if not running
    if ! pgrep -u "$USER" ssh-agent > /dev/null; then
        ssh-agent > "$XDG_RUNTIME_DIR/ssh-agent.env" 2>/dev/null
        if [[ -f "$XDG_RUNTIME_DIR/ssh-agent.env" ]]; then
            . "$XDG_RUNTIME_DIR/ssh-agent.env" >/dev/null
        fi
    fi
    
    # Load SSH keys if they're not already loaded
    if ssh-add -l >/dev/null 2>&1; then
        # Keys are loaded
        :
    else
        # Load personal SSH key with keychain support (macOS)
        if [[ "$OSTYPE" == "darwin"* ]]; then
            ssh-add --apple-use-keychain ~/.ssh/id_ed25519_personal 2>/dev/null
        else
            ssh-add ~/.ssh/id_ed25519_personal 2>/dev/null
        fi
    fi
fi

# Locale settings
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"
export LC_CTYPE="en_US.UTF-8"

# Pager settings
export PAGER="less"
if command -v bat >/dev/null; then
    export PAGER="bat"
fi

# Platform-specific environment variables and aliases
case "$OSTYPE" in
    darwin*)
        # macOS specific
        export HOMEBREW_NO_ANALYTICS=1
        export HOMEBREW_NO_AUTO_UPDATE=1
        alias start="open"
        
        # Modern Bash alias (macOS ships with ancient 3.2.57 from 2007)
        if [[ -x "/opt/homebrew/bin/bash" ]]; then
            alias bash="/opt/homebrew/bin/bash"
        elif [[ -x "/usr/local/bin/bash" ]]; then
            alias bash="/usr/local/bin/bash"
        fi
        ;;
    linux-gnu*)
        # Linux specific
        export DISPLAY=":0"
        # Check if we're in WSL
        if grep -qi microsoft /proc/version 2>/dev/null || [[ "$WSL_DISTRO_NAME" != "" ]]; then
            # WSL specific
            alias start="explorer.exe"
            export WSLENV="USERPROFILE/p:APPDATA/p"
        else
            # Native Linux
            alias start="xdg-open"
        fi
        ;;
    msys|cygwin)
        # Windows specific
        export WSLENV="USERPROFILE/p:APPDATA/p"
        alias start="explorer.exe"
        ;;
esac

# NVM (Node Version Manager) - common part
export NVM_DIR="$HOME/.nvm"

# Common PATH additions
export PATH="$HOME/.local/bin:$HOME/bin:$PATH"
export PATH="$HOME/.cursor/bin:$PATH" 
export PATH="$PATH:/opt/nvim-linux-x86_64/bin"

# Common Aliases
# File listing aliases
alias ll='ls -AlF'
alias la='ls -A'
alias l='ls -CF'

# Add an "alert" alias for long running commands.  Use like so:
#   sleep 10; alert
alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n1|sed -e ''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'')"'

# ANSIBLE ALIASES
alias ap="ansible-playbook"

# TERRAFORM ALIASES
alias tf="terraform"
alias tfp="terraform plan"
alias tfa="terraform apply"

# TERRAGRUN ALIASES
alias tg="terragrunt"

# Language aliases  
alias python="python3"
alias pip="pip3"

# NeoVim configurations
alias craftzdog="NVIM_APPNAME=craftzdog/dotfiles-public/.config/nvim nvim"
alias starter="NVIM_APPNAME=starter nvim"
alias xero="NVIM_APPNAME=xero/dotfiles/neovim/.config/nvim nvim"
alias kickstart='NVIM_APPNAME="nvim-kickstart" nvim'
alias nvchad="NVIM_APPNAME=nvchad nvim"

# Dotfiles sync function (forwards all arguments)
# Dynamically finds the dotfiles directory based on the sync.sh script location
sync() {
    # Try to find sync.sh in common locations
    local sync_script=""
    
    # Check if DOTFILES_DIR is set
    if [[ -n "$DOTFILES_DIR" ]] && [[ -x "$DOTFILES_DIR/scripts/sync.sh" ]]; then
        sync_script="$DOTFILES_DIR/scripts/sync.sh"
    # Check common location
    elif [[ -x "$HOME/workspace/dotfiles/scripts/sync.sh" ]]; then
        sync_script="$HOME/workspace/dotfiles/scripts/sync.sh"
    # Check if we're in a dotfiles repo
    elif [[ -x "./scripts/sync.sh" ]]; then
        sync_script="./scripts/sync.sh"
    # Check parent directory
    elif [[ -x "../scripts/sync.sh" ]]; then
        sync_script="../scripts/sync.sh"
    else
        echo "Error: sync.sh not found. Please set DOTFILES_DIR or ensure dotfiles are in ~/workspace/dotfiles" >&2
        return 1
    fi
    
    "$sync_script" "$@"
}

# Platform-specific clipboard aliases
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    alias pbpaste="xclip -selection clipboard -o"
    alias pbcopy="xclip -selection clipboard"
elif [[ "$OSTYPE" == "darwin"* ]]; then
    # pbpaste/pbcopy already available on macOS
    :
fi