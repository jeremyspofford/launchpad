#!/usr/bin/env bash

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly MAGENTA='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly BOLD='\033[1m'
readonly NC='\033[0m' # No Color

# Function to check if user has any SSH keys already set up
has_ssh_keys() {
    # Check for common SSH key file patterns
    for key in ~/.ssh/id_rsa ~/.ssh/id_ed25519 ~/.ssh/id_ecdsa ~/.ssh/personal_* ~/.ssh/*_rsa ~/.ssh/*_ed25519; do
        if [[ -f "$key" && -f "${key}.pub" ]]; then
            return 0  # Found existing key pair
        fi
    done
    return 1  # No existing keys found
}

# Function to check if SSH key is added to ssh-agent
ssh_key_in_agent() {
    ssh-add -l >/dev/null 2>&1
    return $?
}

# Function to test SSH connection to GitHub
test_github_ssh() {
    ssh -T git@github.com 2>&1 | grep -q "successfully authenticated"
    return $?
}

# Check if user already has SSH keys configured
if has_ssh_keys; then
    echo -e "${BOLD}${GREEN}üîë Existing SSH keys found!${NC}\n"
    
    # List existing keys
    echo -e "${BOLD}${CYAN}Found the following SSH key pairs:${NC}"
    for key in ~/.ssh/id_rsa ~/.ssh/id_ed25519 ~/.ssh/id_ecdsa ~/.ssh/personal_* ~/.ssh/*_rsa ~/.ssh/*_ed25519; do
        if [[ -f "$key" && -f "${key}.pub" ]]; then
            echo -e "${GREEN}  ‚úì $(basename "$key")${NC}"
        fi
    done
    echo
    
    # Test GitHub connection
    if test_github_ssh; then
        echo -e "${BOLD}${GREEN}‚úÖ SSH connection to GitHub is working!${NC}"
        echo -e "${CYAN}No need to set up SSH keys - you're all set.${NC}\n"
    else
        echo -e "${BOLD}${YELLOW}‚ö†Ô∏è  SSH keys exist but GitHub connection failed${NC}"
        echo -e "${CYAN}You may need to add your key to GitHub or check your configuration.${NC}"
        echo -e "${BOLD}${BLUE}   üëâ https://github.com/settings/keys${NC}\n"
        
        # Show existing public keys
        echo -e "${BOLD}${YELLOW}Your existing public keys:${NC}"
        for key in ~/.ssh/*.pub; do
            if [[ -f "$key" ]]; then
                echo -e "\n${BOLD}$(basename "$key"):${NC}"
                echo -e "${GREEN}$(cat "$key")${NC}"
            fi
        done
        echo
    fi
    
# Create new SSH key only if none exist
elif [[ ! -f ~/.ssh/personal_id_ed25519 ]]; then
    mkdir -p ~/.ssh
    ssh-keygen -t ed25519 -C "{{ .email }}" -f ~/.ssh/personal_id_ed25519 -N ""
    
    # Start SSH agent and add key
    eval "$(ssh-agent -s)" >/dev/null 2>&1
    ssh-add ~/.ssh/personal_id_ed25519 2>/dev/null

    echo -e "\n${BOLD}${GREEN}üîë SSH Key Generated Successfully!${NC}\n"
    
    echo -e "${BOLD}${CYAN}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
    echo -e "${BOLD}${CYAN}‚îÇ                    üìã ADD TO GITHUB                            ‚îÇ${NC}"
    echo -e "${BOLD}${CYAN}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}\n"
    
    echo -e "${BOLD}${YELLOW}1. Copy the SSH key below:${NC}"
    echo -e "${GREEN}$(cat ~/.ssh/personal_id_ed25519.pub)${NC}\n"
    
    echo -e "${BOLD}${YELLOW}2. Open GitHub SSH settings:${NC}"
    echo -e "${BOLD}${BLUE}   üëâ https://github.com/settings/keys${NC}\n"
    
    echo -e "${BOLD}${YELLOW}3. Click${NC} ${BOLD}${GREEN}'New SSH key'${NC}"
    echo -e "${BOLD}${YELLOW}4. Paste the key and save${NC}\n"
    
    # Try to copy to clipboard
    if command -v pbcopy >/dev/null 2>&1; then
        cat ~/.ssh/personal_id_ed25519.pub | pbcopy
        echo -e "${GREEN}‚úÖ Key copied to clipboard (macOS)${NC}"
    elif command -v xclip >/dev/null 2>&1; then
        cat ~/.ssh/personal_id_ed25519.pub | xclip -selection clipboard
        echo -e "${GREEN}‚úÖ Key copied to clipboard (Linux)${NC}"
    elif command -v wl-copy >/dev/null 2>&1; then
        cat ~/.ssh/personal_id_ed25519.pub | wl-copy
        echo -e "${GREEN}‚úÖ Key copied to clipboard (Wayland)${NC}"
    else
        echo -e "${YELLOW}üí° Copy the key above manually${NC}"
    fi
    
    # Skip interactive prompt in CI mode
    if [[ "${CI_MODE:-false}" != "true" && "${CI:-false}" != "true" ]]; then
        echo -e "\n${BOLD}${MAGENTA}Press ENTER after adding the key to GitHub...${NC}"
        read
    fi
    
    echo -e "${GREEN}‚úÖ SSH setup complete!${NC}\n"
    
else
    # The specific personal key exists, just ensure it's in ssh-agent and test connection
    echo -e "${BOLD}${GREEN}üîë Personal SSH key already exists!${NC}\n"
    
    # Add to ssh-agent if not already there
    if ! ssh_key_in_agent; then
        eval "$(ssh-agent -s)" >/dev/null 2>&1
        ssh-add ~/.ssh/personal_id_ed25519 2>/dev/null
    fi
    
    # Test GitHub connection
    if test_github_ssh; then
        echo -e "${BOLD}${GREEN}‚úÖ SSH connection to GitHub is working!${NC}"
        echo -e "${CYAN}Your SSH setup is complete.${NC}\n"
    else
        echo -e "${BOLD}${YELLOW}‚ö†Ô∏è  Personal key exists but GitHub connection failed${NC}"
        echo -e "${CYAN}You may need to add this key to GitHub.${NC}"
        echo -e "${BOLD}${BLUE}   üëâ https://github.com/settings/keys${NC}\n"
        echo -e "${BOLD}${YELLOW}Your public key:${NC}"
        echo -e "${GREEN}$(cat ~/.ssh/personal_id_ed25519.pub)${NC}\n"
    fi
fi
